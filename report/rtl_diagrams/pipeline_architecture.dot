digraph pipeline_architecture {
    rankdir=TB;
    bgcolor="white";
    node [fontname="Arial", fontsize=12];
    edge [fontname="Arial", fontsize=10];
    
    // Define subgraph for pipeline stages
    subgraph cluster_pipeline {
        label="Five-Stage Pipeline Processor";
        labelloc="t";
        fontname="Arial";
        fontsize=14;
        style="rounded,filled";
        fillcolor="#f0f8ff";
        color="#4169e1";
        penwidth=2;
        
        // Pipeline registers as separators
        node [shape=record, style="filled", fillcolor="#fff8dc", color="#ff8c00", penwidth=2];
        
        // Stage 1: Instruction Fetch
        IF [label="{<title>IF Fetch Stage|{PC Register|Instruction Memory|PC+4}}",
            fillcolor="#e6f3ff", color="#4682b4", penwidth=2];
        
        IFID [label="IF/ID\nPipeline Register", shape=box, fillcolor="#ffd700", 
              color="#ff8c00", penwidth=2, height=0.8];
        
        // Stage 2: Instruction Decode
        ID [label="{<title>ID Decode Stage|{Instruction Decoder|Register File Read|Immediate Generation}}",
            fillcolor="#e6ffe6", color="#2e8b57", penwidth=2];
        
        IDEX [label="ID/EX\nPipeline Register", shape=box, fillcolor="#ffd700",
              color="#ff8c00", penwidth=2, height=0.8];
        
        // Stage 3: Execute
        EX [label="{<title>EX Execute Stage|{ALU Operation|Branch Decision|Jump Address Calculation}}",
            fillcolor="#ffe6e6", color="#dc143c", penwidth=2];
        
        EXMEM [label="EX/MEM\nPipeline Register", shape=box, fillcolor="#ffd700",
               color="#ff8c00", penwidth=2, height=0.8];
        
        // Stage 4: Memory Access
        MEM [label="{<title>MEM Memory Stage|{Data Memory|Load/Store|Data对齐}}",
             fillcolor="#f0e6ff", color="#9370db", penwidth=2];
        
        MEMWB [label="MEM/WB\nPipeline Register", shape=box, fillcolor="#ffd700",
               color="#ff8c00", penwidth=2, height=0.8];
        
        // Stage 5: Write Back
        WB [label="{<title>WB Writeback Stage|{Writeback Data Selection|Register File Write}}",
            fillcolor="#fff0e6", color="#ff8c00", penwidth=2];
        
        // Main pipeline flow
        IF -> IFID [penwidth=2, color="#4169e1"];
        IFID -> ID [penwidth=2, color="#4169e1"];
        ID -> IDEX [penwidth=2, color="#4169e1"];
        IDEX -> EX [penwidth=2, color="#4169e1"];
        EX -> EXMEM [penwidth=2, color="#4169e1"];
        EXMEM -> MEM [penwidth=2, color="#4169e1"];
        MEM -> MEMWB [penwidth=2, color="#4169e1"];
        MEMWB -> WB [penwidth=2, color="#4169e1"];
    }
    
    // External components
    node [shape=box, style="rounded,filled"];
    
    // Register File
    RF [label="Register File\n(32 × 32-bit)", 
        fillcolor="#ffebcd", color="#d2691e", penwidth=2, fontsize=11];
    
    // Control Units
    subgraph cluster_control {
        label="Control Units";
        labelloc="b";
        fontname="Arial";
        fontsize=11;
        style="dashed,filled";
        fillcolor="#fafafa";
        color="#808080";
        
        FWD [label="Forwarding Unit", 
             fillcolor="#ffe4e1", color="#ff6347", penwidth=2,
             shape=box, style="rounded,filled", fontsize=10];
        
        HAZ [label="Hazard Detection Unit", 
             fillcolor="#ffe4e1", color="#ff6347", penwidth=2,
             shape=box, style="rounded,filled", fontsize=10];
    }
    
    // Memory Interfaces
    subgraph cluster_memory {
        label="Memory Interfaces";
        labelloc="b";
        fontname="Arial";
        fontsize=11;
        style="dashed,filled";
        fillcolor="#fafafa";
        color="#808080";
        
        IMEM [label="Instruction Memory\n(AHB)", 
              fillcolor="#e0ffff", color="#20b2aa", penwidth=2,
              shape=box, style="rounded,filled", fontsize=10];
        
        DMEM [label="Data Memory\n(AHB)", 
              fillcolor="#e0ffff", color="#20b2aa", penwidth=2,
              shape=box, style="rounded,filled", fontsize=10];
    }
    
    // Connections - Register File
    ID -> RF [label="Read rs1/rs2", style="dashed", color="#2e8b57", 
              penwidth=1.5, fontsize=9];
    RF -> ID [label="Register Data", style="dashed", color="#2e8b57", 
              penwidth=1.5, fontsize=9];
    WB -> RF [label="Write rd", style="bold", color="#ff8c00", 
              penwidth=2, fontsize=9];
    
    // Connections - Forwarding
    EX -> FWD [style="dashed", color="#a0a0a0", penwidth=1];
    MEM -> FWD [style="dashed", color="#a0a0a0", penwidth=1];
    FWD -> EX [label="Forward Data", style="bold", color="#ff6347", 
               penwidth=2, fontsize=9];
    
    // Connections - Hazard Detection
    ID -> HAZ [style="dashed", color="#a0a0a0", penwidth=1];
    EX -> HAZ [style="dashed", color="#a0a0a0", penwidth=1];
    HAZ -> IF [label="Stall", style="dotted", color="#ff0000", 
               penwidth=2, fontsize=9];
    HAZ -> IFID [label="Bubble", style="dotted", color="#ff0000", 
                 penwidth=2, fontsize=9];
    
    // Connections - Memory Interfaces
    IF -> IMEM [label="Fetch Request", color="#4682b4", penwidth=1.5, fontsize=9];
    IMEM -> IF [label="Instruction Data", color="#4682b4", penwidth=1.5, fontsize=9];
    MEM -> DMEM [label="Memory Request", color="#9370db", penwidth=1.5, fontsize=9];
    DMEM -> MEM [label="Read Data", color="#9370db", penwidth=1.5, fontsize=9];
    
    // Branch feedback
    EX -> IF [label="Branch Jump\nTarget Address", style="bold", color="#0000ff", 
              penwidth=2, fontsize=9, constraint=false];
}
