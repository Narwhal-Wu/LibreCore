digraph soc_architecture {
    rankdir=TB;
    bgcolor="white";
    node [fontname="Arial", fontsize=11];
    edge [fontname="Arial", fontsize=9];
    
    // Title node
    title [label="LibreCore SoC System Architecture", 
           shape=plaintext, fontsize=16, fontname="Arial Bold"];
    
    // External interfaces at left side - vertically arranged
    subgraph cluster_external {
        label="External Interfaces";
        labelloc="t";
        fontname="Arial";
        fontsize=12;
        style="dashed,filled";
        fillcolor="#f5f5f5";
        color="#696969";
        
        node [shape=box, style="rounded,filled", fillcolor="#fffacd", 
              color="#daa520", penwidth=2];
        
        CLK_IN [label="Clock Input\nCLK 100MHz"];
        RESET_IN [label="Reset Signal\nRESET"];
        
        node [shape=parallelogram, fillcolor="#e6e6fa", color="#9370db", penwidth=2];
        UART_IO [label="UART\nRX/TX"];
        BUTTONS [label="Button Input\nButtons (5x)"];
        LEDS [label="LED Output\nLEDs (16x)"];
        DISPLAY [label="7-Segment Display"];
        
        // Force vertical arrangement
        CLK_IN -> RESET_IN -> UART_IO -> BUTTONS -> LEDS -> DISPLAY [style=invis];
    }
    
    // Main SoC container
    subgraph cluster_soc {
        label="SoC Internal";
        labelloc="b";
        fontname="Arial Bold";
        fontsize=13;
        style="rounded,filled";
        fillcolor="#ffffff";
        color="#000000";
        penwidth=3;
        
        // CPU Core
        subgraph cluster_cpu {
            label="RISC-V CPU Core";
            labelloc="t";
            fontname="Arial";
            fontsize=12;
            style="rounded,filled";
            fillcolor="#e6f3ff";
            color="#4169e1";
            penwidth=2;
            
            CPU [label="myCPU\nFive-Stage Pipeline Processor\nRV32I Instruction Set\n\nAHB-I / AHB-D",
                 shape=box, style="rounded,filled", fillcolor="#b0d4ff", color="#4169e1", 
                 penwidth=2, fontsize=11];
        }
        
        // AHB Bus System
        subgraph cluster_ahb {
            label="AHB Bus Interconnect System";
            labelloc="t";
            fontname="Arial";
            fontsize=12;
            style="rounded,filled";
            fillcolor="#fff8dc";
            color="#ff8c00";
            penwidth=2;
            
            node [shape=box, style="rounded,filled", fontsize=10];
            
            DECODER [label="Address Decoder\nAHB Decoder", 
                    fillcolor="#ffd700", color="#ff8c00", penwidth=2];
            
            MUX [label="Data Multiplexer\nAHB Multiplexer", 
                fillcolor="#ffd700", color="#ff8c00", penwidth=2];
        }
        
        // Memory Subsystem
        subgraph cluster_memory {
            label="Memory Subsystem";
            labelloc="t";
            fontname="Arial";
            fontsize=12;
            style="rounded,filled";
            fillcolor="#e0ffff";
            color="#20b2aa";
            penwidth=2;
            
            // Controllers
            subgraph cluster_ctrl {
                rank=same;
                node [shape=box, style="rounded,filled", fontsize=10];
                
                IROM_CTRL [label="Instruction ROM Controller\nIROM Controller\n(AHB → ROM)", 
                          fillcolor="#afeeee", color="#20b2aa", penwidth=2];
                
                BRAM_CTRL [label="Data RAM Controller\nBRAM Controller\n(AHB → RAM)", 
                          fillcolor="#afeeee", color="#20b2aa", penwidth=2];
            }
            
            // Memory blocks
            subgraph cluster_mem {
                rank=same;
                node [shape=cylinder, style="filled", fontsize=10];
                
                IROM [label="Instruction Memory\nInstruction ROM\n64 KB", 
                     fillcolor="#f0ffff", color="#48d1cc", penwidth=2];
                
                BRAM [label="Data Memory\nData RAM\n64 KB", 
                     fillcolor="#f0ffff", color="#48d1cc", penwidth=2];
            }
        }
        
        // Clock and Reset System
        subgraph cluster_clk {
            label="Clock & Reset System";
            labelloc="t";
            fontname="Arial";
            fontsize=11;
            style="rounded,filled";
            fillcolor="#fffaf0";
            color="#ff6347";
            penwidth=2;
            
            node [shape=box, style="rounded,filled", fontsize=10];
            
            PLL [label="PLL Clock Management\nPhase-Locked Loop", 
                fillcolor="#ffe4b5", color="#ff8c00", penwidth=2];
        }
        
        // Peripheral Subsystem - vertically arranged
        subgraph cluster_periph {
            label="Peripheral Subsystem";
            labelloc="t";
            fontname="Arial";
            fontsize=11;
            style="rounded,filled";
            fillcolor="#f0fff0";
            color="#228b22";
            penwidth=2;
            
            node [shape=box, style="rounded,filled", fontsize=10];
            
            KEY [label="Key Debounce", 
                fillcolor="#90ee90", color="#228b22", penwidth=2];
            
            UART [label="UART Controller\nSerial Interface", 
                 fillcolor="#90ee90", color="#228b22", penwidth=2];
            
            LED [label="LED Driver", 
                fillcolor="#90ee90", color="#228b22", penwidth=2];
            
            SEG7 [label="7-Segment Driver", 
                 fillcolor="#90ee90", color="#228b22", penwidth=2];
            
            // Force vertical arrangement
            KEY -> UART -> LED -> SEG7 [style=invis];
        }
    }
    
    // Invisible title positioning
    title -> CLK_IN [style=invis];
    
    // External to Clock/Reset
    CLK_IN -> PLL [label="100MHz", color="#ff8c00", penwidth=2];
    RESET_IN -> PLL [label="Reset", color="#ff0000", penwidth=2];
    
    // Clock distribution (from PLL)
    edge [label="CLK", color="#ffa500", style="dashed", penwidth=1.5];
    PLL -> CPU;
    PLL -> DECODER;
    PLL -> MUX;
    PLL -> IROM_CTRL;
    PLL -> BRAM_CTRL;
    edge [label="", style="solid"];
    
    // CPU to AHB Bus
    CPU -> DECODER [label="Instruction Address\nHADDR_I", color="#4169e1", penwidth=2];
    CPU -> DECODER [label="Data Address\nHADDR_D", color="#9370db", penwidth=2];
    
    // AHB Decoder to Controllers
    DECODER -> IROM_CTRL [label="HSEL_IROM", color="#20b2aa", penwidth=2];
    DECODER -> BRAM_CTRL [label="HSEL_BRAM", color="#20b2aa", penwidth=2];
    
    // Controllers to Memory
    IROM_CTRL -> IROM [label="Address/Control", color="#48d1cc", penwidth=1.5];
    BRAM_CTRL -> BRAM [label="Address/Control", color="#48d1cc", penwidth=1.5];
    
    // Memory read back
    IROM -> IROM_CTRL [label="Instruction Data", color="#48d1cc", 
                        penwidth=1.5, style="dashed"];
    BRAM -> BRAM_CTRL [label="Read/Write Data", color="#48d1cc", 
                        penwidth=1.5, style="dashed", dir=both];
    
    // Controllers to MUX
    IROM_CTRL -> MUX [label="HRDATA", color="#20b2aa", 
                      penwidth=1.5, style="dashed"];
    BRAM_CTRL -> MUX [label="HRDATA", color="#20b2aa", 
                      penwidth=1.5, style="dashed"];
    
    // MUX back to CPU
    MUX -> CPU [label="Instruction", color="#4169e1", penwidth=2, style="dashed"];
    MUX -> CPU [label="Data", color="#9370db", penwidth=2, style="dashed"];
    
    // External to Peripherals
    BUTTONS -> KEY [label="Input", color="#228b22", penwidth=1.5];
    KEY -> CPU [label="Key Value", color="#228b22", penwidth=1, style="dotted"];
    
    CPU -> SEG7 [label="显示Data", color="#228b22", penwidth=1, style="dotted"];
    CPU -> LED [label="LED Status", color="#228b22", penwidth=1, style="dotted"];
    CPU -> UART [label="串口Data", color="#228b22", penwidth=1, style="dotted"];
    
    // Peripherals to External
    SEG7 -> DISPLAY [label="Drive", color="#228b22", penwidth=1.5];
    LED -> LEDS [label="Drive", color="#228b22", penwidth=1.5];
    UART -> UART_IO [label="TX/RX", color="#228b22", penwidth=1.5, dir=both];
    
    // Legend
    subgraph cluster_legend {
        label="Legend";
        labelloc="b";
        fontname="Arial";
        fontsize=10;
        style="dashed";
        fillcolor="#fafafa";
        color="#808080";
        
        node [shape=plaintext, fontsize=9];
        legend [label=<
            <TABLE BORDER="0" CELLBORDER="0" CELLSPACING="2">
            <TR><TD ALIGN="LEFT">━━━━ 实线：Data/地址通路</TD></TR>
            <TR><TD ALIGN="LEFT">┈┈┈┈ 虚线：Read Data返回</TD></TR>
            <TR><TD ALIGN="LEFT">······ Dotted: Control/Status Signal</TD></TR>
            </TABLE>
        >];
    }
}
